<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amrita Attendance Supreme Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --normal: #d4edda; --swap: #fff3cd; --free: #e2e3f5; --absent: #f8d7da; }
        body { background: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-bottom: 50px; }
        .hidden { display: none !important; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .nav-tabs .nav-link { color: #555; font-weight: 600; border: none; padding: 12px 25px; cursor: pointer; }
        .nav-tabs .nav-link.active { color: var(--accent) !important; border-bottom: 3px solid var(--accent) !important; background: transparent !important; }

        /* Timetable Grid & Colors */
        #timetableGrid th, #timetableGrid td { border: 1px solid #eee; text-align: center; vertical-align: middle; height: 100px; min-width: 120px; padding: 5px; font-size: 0.85rem; }
        .day-col { background: var(--primary) !important; color: white !important; font-weight: bold; width: 100px !important; }
        .date-sub { font-size: 0.7rem; display: block; opacity: 0.7; font-weight: normal; }
        
        .slot-box { background: white; border: 1px solid #ddd; padding: 5px; font-size: 0.8rem; height: 100%; display: flex; flex-direction: column; justify-content: center; transition: 0.2s; cursor: pointer; border-radius: 6px; }
        .slot-box:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        /* Category Colors */
        .cat-normal { background: var(--normal) !important; border-left: 4px solid #28a745; }
        .cat-swap { background: var(--swap) !important; border-left: 4px solid #ffc107; }
        .cat-free { background: var(--free) !important; border-left: 4px solid #6c757d; }
        .cat-unmarked { background: var(--absent) !important; border-left: 4px solid #dc3545; }

        /* FIXED: Lowercase class names to match DB values */
        .status-absent { color: #c0392b; font-weight: bold; text-transform: capitalize; }
        .status-present { color: #27ae60; font-weight: bold; text-transform: capitalize; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark shadow-sm mb-4">
    <div class="container-fluid px-5">
        <a class="navbar-brand fw-bold">ðŸŽ“ Attendance Supreme</a>
        <div id="authArea">
            <span id="roleLabel" class="badge bg-danger me-3 p-2"></span>
            <button id="logoutBtn" class="btn btn-outline-light btn-sm hidden" onclick="logout()">Logout</button>
        </div>
    </div>
</nav>

<div class="container">
    <!-- LOGIN SECTION -->
    <div id="loginSection" class="row justify-content-center">
        <div class="col-md-4 card p-4 mt-5">
            <h5 class="text-center mb-3 text-secondary">Sign In</h5>
            <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email Address">
            <input type="password" id="loginPass" class="form-control mb-3" placeholder="Password">
            <button class="btn btn-danger w-100 fw-bold" onclick="login()">LOGIN</button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
        <ul class="nav nav-tabs" id="myTab">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#viewTab" onclick="renderGrid()">Timetable View</button></li>
            <li class="nav-item admin-only"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#academicTab" onclick="refreshAllData()">Academic Config</button></li>
            <li class="nav-item admin-only"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#facultyTab" onclick="refreshAllData()">Faculty Mgmt</button></li>
        </ul>

        <div class="tab-content pt-3">
            
            <!-- TAB 1: TIMETABLE VIEW -->
            <div class="tab-pane fade show active" id="viewTab">
                <div class="card p-4">
                    <div class="row g-2 mb-3 align-items-center">
                        <div class="col-md-3"><label class="small fw-bold">Section</label><select id="vSec" class="form-select section-list" onchange="renderGrid()"></select></div>
                        <div class="col-md-2"><label class="small fw-bold">Semester</label><select id="vSem" class="form-select" onchange="renderGrid()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
                        <div class="col-md-3"><label class="small fw-bold">Week Of</label><input type="date" id="vWeekDate" class="form-control" onchange="renderGrid()"></div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-success">Normal</span> <span class="badge bg-warning text-dark">Swap</span> <span class="badge bg-secondary">Free</span> <span class="badge bg-danger">Unmarked</span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0" id="timetableGrid">
                            <thead class="table-light"><tr id="hRow"></tr></thead>
                            <tbody id="bRow"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 2: ACADEMIC CONFIG -->
            <div class="tab-pane fade" id="academicTab">
                <div class="row">
                    <!-- Setup Structure -->
                    <div class="col-md-4">
                        <div class="card p-3 mb-3 bg-light border">
                            <h6 class="text-danger border-bottom pb-2">1. Organization Structure</h6>
                            
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" id="dName" class="form-control" placeholder="Dept Name">
                                <input type="text" id="dCode" class="form-control" placeholder="Code">
                                <button class="btn btn-dark" onclick="createDept()">Add Dept</button>
                            </div>

                            <div class="input-group input-group-sm mb-2">
                                <select id="bDept" class="form-select dept-list" style="max-width: 80px;"></select>
                                <input type="text" id="bName" class="form-control" placeholder="Batch (e.g. 2024)">
                                <button class="btn btn-dark" onclick="createBatch()">Add Batch</button>
                            </div>

                            <div class="input-group input-group-sm">
                                <select id="sBatch" class="form-select batch-list" style="max-width: 100px;"></select>
                                <input type="text" id="sName" class="form-control" placeholder="Section (A/B)">
                                <button class="btn btn-dark" onclick="createSection()">Add Sec</button>
                            </div>
                        </div>

                        <div class="card p-3 bg-light border">
                            <h6 class="text-danger border-bottom pb-2">2. Course Catalog</h6>
                            <input type="text" id="cCode" class="form-control form-control-sm mb-1" placeholder="Course Code (e.g. CSE101)">
                            <input type="text" id="cName" class="form-control form-control-sm mb-1" placeholder="Course Name">
                            <select id="cDept" class="form-select form-select-sm mb-2 dept-list"></select>
                            <button class="btn btn-success btn-sm w-100" onclick="createCourse()">Add to Catalog</button>
                        </div>
                    </div>

                    <!-- Setup Students & Timetable -->
                    <div class="col-md-8">
                        <div class="card p-3 mb-3">
                            <h6 class="text-primary">3. Student Management</h6>
                            <div class="row g-2 align-items-end">
                                <div class="col-3"><input type="text" id="stuRoll" class="form-control form-control-sm" placeholder="Roll No"></div>
                                <div class="col-3"><input type="text" id="stuName" class="form-control form-control-sm" placeholder="Student Name"></div>
                                <div class="col-4"><select id="stuSection" class="form-select form-select-sm section-list"></select></div>
                                <div class="col-2"><button class="btn btn-primary btn-sm w-100" onclick="createStudent()">Add</button></div>
                            </div>
                        </div>

                        <div class="card p-3 border-danger" style="border:1px solid #ffcccc">
                            <h6 class="text-danger">4. Timetable Slot Configuration</h6>
                            <div class="row g-2 mb-2">
                                <div class="col-3"><small>Section</small><select id="ttSec" class="form-select form-select-sm section-list"></select></div>
                                <div class="col-2"><small>Sem</small><select id="ttSem" class="form-select form-select-sm"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
                                <div class="col-3"><small>Day</small><select id="ttDay" class="form-select form-select-sm"><option>Mon</option><option>Tue</option><option>Wed</option><option>Thu</option><option>Fri</option></select></div>
                                <div class="col-2"><small>Slot</small><select id="ttSlot" class="form-select form-select-sm"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option></select></div>
                                <div class="col-2"><small>Room</small><input type="text" id="ttRoom" class="form-control form-control-sm" placeholder="101"></div>
                            </div>
                            <div class="row g-2">
                                <div class="col-5"><small>Course</small><select id="ttCourse" class="form-select form-select-sm course-list"></select></div>
                                <div class="col-5"><small>Faculty</small><select id="ttFac" class="form-select form-select-sm faculty-list"></select></div>
                                <div class="col-2"><br><button class="btn btn-danger btn-sm w-100" onclick="createSlot()">Save</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: FACULTY MANAGEMENT -->
            <div class="tab-pane fade" id="facultyTab">
                <div class="row">
                    <!-- Create Profile -->
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h6>Step A: Add Faculty Profile</h6>
                            <input type="text" id="fName" class="form-control mb-2" placeholder="Full Name">
                            <input type="email" id="fEmail" class="form-control mb-2" placeholder="Official Email">
                            <select id="fDept" class="form-select mb-2 dept-list"></select>
                            <input type="text" id="fTok" class="form-control mb-3" placeholder="6-Digit Auth Code">
                            <button class="btn btn-primary w-100" onclick="createFacultyProfile()">Save Profile</button>
                        </div>
                    </div>

                    <!-- Create Login -->
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h6>Step B: Create User Login</h6>
                            <p class="small text-muted">Select a profile to assign a password.</p>
                            <select id="fProfile" class="form-select mb-2 faculty-list"></select>
                            <input type="password" id="fPass" class="form-control mb-3" placeholder="New Password">
                            <button class="btn btn-success w-100" onclick="createFacultyLogin()">Activate Account</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: CR MARKING -->
<div class="modal fade" id="markingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white"><h5>Mark Attendance</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="row g-2 mb-3 bg-light p-2 rounded">
                    <div class="col-6"><label class="small fw-bold">Actual Course:</label><select id="selCourse" class="form-select course-list"></select></div>
                    <div class="col-6 pt-4 text-end"><div class="form-check form-switch d-inline-block"><input class="form-check-input" type="checkbox" id="isFree"><label class="fw-bold text-danger ms-2">FREE HOUR</label></div></div>
                </div>
                <div id="stuList" class="table-responsive" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="submitAttendance()">Submit Attendance</button></div>
        </div>
    </div>
</div>

<!-- MODAL: ADMIN HISTORY/VIEW -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white"><h5 id="histTitle">Slot Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div id="recordLog" class="table-responsive"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = "http://localhost:3000/api";
    let activeSlot = null;

    // --- UTILS ---
    async function req(url, method = 'GET', body = null) {
        const h = { 'Content-Type': 'application/json' };
        if (localStorage.getItem('token')) h['Authorization'] = `Bearer ${localStorage.getItem('token')}`;
        
        try {
            const res = await fetch(`${API}${url}`, { method, headers: h, body: body ? JSON.stringify(body) : null });
            const data = await res.json();
            if (!res.ok) { alert(data.error || "Request failed"); throw data; }
            return data;
        } catch (e) { console.error(e); throw e; }
    }

    function getMonday(d) {
        d = new Date(d); let day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
        return new Date(d.setDate(diff)).toISOString().split('T')[0];
    }

    // --- AUTH ---
    async function login() {
        try {
            const d = await req('/login', 'POST', { email: loginEmail.value, password: loginPass.value });
            localStorage.setItem('token', d.token); localStorage.setItem('role', d.role); location.reload();
        } catch(e){}
    }
    function logout() { localStorage.clear(); location.reload(); }

    // --- LOADERS ---
    async function refreshAllData() {
        const [depts, batches, sections, courses, facs] = await Promise.all([
            req('/admin/depts'), req('/admin/batches'), req('/admin/sections'), req('/admin/courses'), req('/admin/faculty')
        ]);
        
        fillSelect('.dept-list', depts, 'id', 'dept_code');
        fillSelect('.batch-list', batches, 'id', 'batch_name');
        
        // Show Dept Code in Section Dropdown
        const secList = sections.map(s => ({id: s.id, name: `${s.batch_name} - ${s.section_name}`}));
        fillSelect('.section-list', secList, 'id', 'name');
        
        fillSelect('.course-list', courses, 'course_code', 'course_name');
        
        // Use profile_id for faculty value
        fillSelect('.faculty-list', facs, 'profile_id', 'faculty_name');
    }

    function fillSelect(cls, data, val, txt) {
        document.querySelectorAll(cls).forEach(sel => {
            const cur = sel.value;
            sel.innerHTML = `<option value="">Select...</option>` + data.map(i => `<option value="${i[val]}">${i[txt]}</option>`).join('');
            sel.value = cur;
        });
    }

    // --- GRID LOGIC ---
    async function renderGrid() {
        const secId = vSec.value;
        const sem = vSem.value;
        const startDay = getMonday(vWeekDate.value || new Date());
        
        if(!secId) return;

        // Use new week-grid endpoint which joins session data
        const data = await req(`/common/week-grid?section_id=${secId}&semester=${sem}&start_date=${startDay}`);
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
        
        // Header (9 Slots)
        hRow.innerHTML = '<th>Day</th>' + [1,2,3,4,5,6,7,8,9].map(i => `<th>${i}</th>`).join('');
        
        // Rows
        bRow.innerHTML = days.map((day, idx) => {
            let d = new Date(startDay); d.setDate(d.getDate() + idx);
            const dateStr = d.toISOString().split("T")[0];
            const displayDate = d.toLocaleDateString('en-GB', {day:'numeric', month:'short'});

            let row = `<td class="day-col">${day}<br><span class="date-sub">${displayDate}</span></td>`;
            
            for(let i=1; i<=9; i++) {
                const s = data.find(x => x.day === day && x.slot_number === i);
                if(s) {
                    // determine color class
                    let cssClass = '';
                    if(s.session_category) {
                        if(s.session_category === 'free') cssClass = 'cat-free';
                        else if(s.session_category === 'swap') cssClass = 'cat-swap';
                        else cssClass = 'cat-normal';
                    } else {
                        // Check if past date
                        if(new Date(dateStr) < new Date().setHours(0,0,0,0)) cssClass = 'cat-unmarked';
                    }

                    row += `<td>
                        <div class="slot-box ${cssClass}" onclick='handleClick(${JSON.stringify(s)}, "${dateStr}")'>
                            <strong>${s.course_code}</strong>
                            <div class="text-muted small" style="font-size:0.75rem">${s.faculty_name.split(' ')[0]}</div>
                            ${s.room_info ? `<div class="badge bg-light text-dark border px-1" style="font-size:0.6rem">${s.room_info}</div>` : ''}
                        </div>
                    </td>`;
                } else row += '<td class="bg-light"></td>';
            }
            return `<tr>${row}</tr>`;
        }).join('');
    }

    // --- CLICK HANDLER ---
    async function handleClick(slot, date) {
        activeSlot = { ...slot, date };
        const role = localStorage.getItem('role');
        
        // CR MODE: Mark Attendance
        if(role === 'cr') {
            const students = await req(`/cr/students-by-timetable/${slot.id}`);
            const courses = await req('/cr/my-courses'); // For swap dropdown
            
            fillSelect('#selCourse', courses, 'course_code', 'course_name');
            selCourse.value = slot.course_code;
            
            stuList.innerHTML = `<table class="table table-hover mb-0">
                <thead class="table-light sticky-top"><tr><th>Roll</th><th>Name</th><th>Status</th></tr></thead>
                <tbody>${students.map(s => `
                    <tr>
                        <td>${s.roll_number}</td>
                        <td>${s.full_name}</td>
                        <td><div class="form-check form-switch"><input class="form-check-input stu-tgl" type="checkbox" checked data-id="${s.id}"></div></td>
                    </tr>`).join('')}
                </tbody></table>`;
            
            new bootstrap.Modal(markingModal).show();
        } 
        // ADMIN/FACULTY MODE: View Records
        else {
            if(!slot.session_id) { alert("No attendance marked for this slot."); return; }
            
            histTitle.innerText = `${slot.course_name} (${date})`;
            const recs = await req(`/admin/records-by-session/${slot.session_id}`);
            
            recordLog.innerHTML = `<table class="table table-sm">
                <thead><tr><th>Roll</th><th>Name</th><th>Status</th></tr></thead>
                <tbody>${recs.map(r => `
                    <tr>
                        <td>${r.roll_number}</td>
                        <td>${r.full_name}</td>
                        <td class="status-${r.status}">${r.status}</td>
                    </tr>`).join('')}
                </tbody></table>`;
            
            new bootstrap.Modal(historyModal).show();
        }
    }

    // --- ACTIONS ---
    async function submitAttendance() {
        // FIXED: Sending 'present'/'absent' (lowercase) to match check constraint
        const records = Array.from(document.querySelectorAll('.stu-tgl')).map(i => ({ id: i.dataset.id, status: i.checked ? 'present' : 'absent' }));
        await req('/cr/attendance', 'POST', { 
            timetable_id: activeSlot.id, 
            date: activeSlot.date, 
            records, 
            selected_course_code: selCourse.value, 
            is_free: isFree.checked 
        });
        bootstrap.Modal.getInstance(markingModal).hide(); 
        renderGrid();
    }

    // --- ADMIN CREATION ---
    async function createDept() { await req('/admin/depts', 'POST', { name: dName.value, code: dCode.value }); refreshAllData(); }
    async function createBatch() { await req('/admin/batches', 'POST', { dept_id: bDept.value, batch_name: bName.value, start_year: 2024, end_year: 2028 }); refreshAllData(); }
    async function createSection() { await req('/admin/sections', 'POST', { batch_id: sBatch.value, section_name: sName.value }); refreshAllData(); }
    async function createCourse() { await req('/admin/courses', 'POST', { code: cCode.value, name: cName.value, dept_id: cDept.value, credits: 3 }); refreshAllData(); }
    
    async function createStudent() { 
        await req('/admin/students', 'POST', { roll: stuRoll.value, name: stuName.value, email: "student@univ.edu", section_id: stuSection.value }); 
        alert("Student Added");
        stuRoll.value = ''; stuName.value = '';
    }
    
    // NEW: Create Profile
    async function createFacultyProfile() { 
        await req('/admin/faculty-profile', 'POST', { name: fName.value, email: fEmail.value, dept_id: fDept.value, auth_key: fTok.value }); 
        alert("Profile Created"); refreshAllData();
    }

    // NEW: Create Login
    async function createFacultyLogin() {
        await req('/admin/faculty-login', 'POST', { faculty_profile_id: fProfile.value, password: fPass.value });
        alert("Login Activated"); refreshAllData();
    }

    // NEW: Create Slot with Profile ID
    async function createSlot() { 
        await req('/admin/timetable', 'POST', { 
            section_id: ttSec.value, 
            semester: ttSem.value, 
            day: ttDay.value, 
            slot: ttSlot.value, 
            course_code: ttCourse.value, 
            faculty_id: ttFac.value, // This is actually profile_id from dropdown value
            room: ttRoom.value 
        }); 
        alert("Slot Saved"); 
    }

    // --- INIT ---
    window.onload = () => {
        const r = localStorage.getItem('role');
        if (r) {
            loginSection.classList.add('hidden'); 
            dashboard.classList.remove('hidden'); 
            logoutBtn.classList.remove('hidden');
            roleLabel.innerText = r.toUpperCase();
            vWeekDate.value = getMonday(new Date());
            
            if(r !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.classList.add('hidden'));

            refreshAllData().then(() => { if(vSec.value) renderGrid(); });
        }
    };
</script>
</body>
</html>